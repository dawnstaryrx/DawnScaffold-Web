const Math = window.Math;
const head = document.getElementsByTagName("head")[0];
const TIMEOUT = 1e4;

const TAC_LOADING_DIV = `
  <div id="tac-loading" style="
    border: 1px solid #eee;
    border-radius: 5px;
    width: 318px;
    height: 318px;
    line-height: 318px;
    color: #606266;
    text-align: center;
    position: relative;
    box-sizing: border-box;
  ">
    请稍等...
  </div>
`;

/** 显示加载中提示 */
function showLoading(selector) {
  const el = document.querySelector(selector);
  if (el) el.innerHTML = TAC_LOADING_DIV;
}

/** 隐藏加载中提示 */
function hideLoading(selector) {
  const el = document.querySelector(selector);
  if (el) el.innerHTML = "";
}

/** 加载验证码脚本及样式 */
function loadCaptchaScript(config, tacConfig, params, resolve, reject) {
  const scriptUrls = config.scriptUrls;
  const cssUrls = config.cssUrls;
  const timeout = config.timeout || TIMEOUT;
  let remain = scriptUrls.length + cssUrls.length;

  /** 资源加载完成回调 */
  function done(success, info) {
    remain--;
    if (success && remain === 0) {
      hideLoading(tacConfig.bindEl);
      if (!window.TAC) throw new Error("TAC未加载，请检查地址是否正确");
      resolve(new TAC(tacConfig, params));
    } else if (!success) {
      hideLoading(tacConfig.bindEl);
      reject(info);
    }
  }

  // 延时显示加载提示
  setTimeout(() => {
    if (remain !== 0) showLoading(tacConfig.bindEl);
  }, 10);

  // 加载脚本与样式
  scriptUrls.forEach((item) => {
    loadResource(typeof item === "string" ? { url: item } : item, done, "script", timeout);
  });

  cssUrls.forEach((item) => {
    loadResource(typeof item === "string" ? { url: item } : item, done, "link", timeout);
  });
}

/** 动态加载资源（script 或 link） */
function loadResource(resource, callback, type = "script", timeout) {
  if (document.querySelector(`${type}[${type === "script" ? "src" : "href"}="${resource.url}"]`)) {
    callback(true, resource);
    return;
  }

  let loaded = false;
  const el = document.createElement(type);

  if (type === "link") {
    el.rel = "stylesheet";
  } else {
    el.async = true;
  }

  el[type === "script" ? "src" : "href"] = resource.url;

  let timer;
  el.onload = el.onreadystatechange = () => {
    if (!loaded && (!el.readyState || el.readyState === "loaded" || el.readyState === "complete")) {
      function check(next) {
        if (resource.checkOnReady) {
          timer = setTimeout(() => {
            resource.checkOnReady() ? next() : check(next);
          }, 10);
        } else {
          next();
        }
      }

      check(() => {
        loaded = true;
        setTimeout(() => callback(true, resource), 0);
      });
    }
  };

  el.onerror = () => {
    callback(false, resource);
  };

  head.appendChild(el);

  // 超时控制
  setTimeout(() => {
    if (!loaded) {
      if (timer) clearTimeout(timer);
      el.onload = el.onerror = null;
      el.remove && el.remove();
      callback(false, resource);
    }
  }, timeout || TIMEOUT);
}

/** 主加载函数 */
function loadTAC(urlOrConfig, tacConfig, params) {
  return new Promise((resolve, reject) => {
    let config = typeof urlOrConfig === "string" ? { url: urlOrConfig } : urlOrConfig;

    if (config.url) {
      if (!config.url.endsWith("/")) config.url += "/";
      config.scriptUrls = config.scriptUrls || [config.url + "js/tac.min.js"];
      config.cssUrls = config.cssUrls || [config.url + "css/tac.css"];
    }

    if (config.scriptUrls && config.cssUrls) {
      loadCaptchaScript(config, tacConfig, params, resolve, reject);
    } else {
      reject("请按照文档配置tac");
    }
  });
}

// 自动检测路径（从 load.js 自身推断）
setTimeout(() => {
  const scripts = document.scripts;
  let basePath = null;

  for (let i = 0; i < scripts.length; i++) {
    if (
      scripts[i].src.indexOf("load.js") > 1 ||
      scripts[i].src.indexOf("load.min.js") > 1
    ) {
      basePath = scripts[i].src.substring(
        scripts[i].src.indexOf("/"),
        scripts[i].src.lastIndexOf("/")
      );
      break;
    }
  }
}, 100);

// 暴露全局方法
window.loadCaptchaScript = loadCaptchaScript;
window.loadTAC = loadTAC;
window.initTAC = loadTAC;
